<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>화면 공유 클라이언트</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            width: 100%;
            max-width: 480px;
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .warning-banner {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #ffeeba;
            text-align: left;
        }
        .connection-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .code-display {
            background-color: #eee;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            text-align: center;
            margin: 10px 0;
            font-size: 24px;
            letter-spacing: 3px;
            font-weight: bold;
        }
        .status {
            font-weight: bold;
            margin-top: 10px;
        }
        .status.connected {
            color: #4CAF50;
        }
        .status.connecting {
            color: #ff9800;
        }
        .status.disconnected {
            color: #f44336;
        }
        .qr-code {
            margin: 15px auto;
            display: block;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="httpWarning" class="warning-banner hidden">
            <strong>HTTP 환경 감지됨!</strong> 기능이 제한될 수 있으니 HTTPS 환경에서 사용하는 것이 좋습니다.
        </div>
        
        <h1>화면 공유 클라이언트</h1>
        
        <div id="step1">
            <button id="startBtn">화면 공유 시작</button>
            <p>화면 공유를 시작하면 6자리 연결 코드가 생성됩니다.</p>
        </div>
        
        <div id="step2" style="display:none">
            <div class="connection-info">
                <p>아래 코드를 뷰어에게 알려주세요:</p>
                <div class="code-display" id="connectionCode">------</div>
                <button id="copyCodeBtn">코드 복사</button>
                <hr>
                <p>뷰어 코드 입력:</p>
                <input type="text" id="viewerCodeInput" placeholder="뷰어가 제공한 4자리 코드 입력" maxlength="4">
                <button id="connectBtn">연결하기</button>
                <div class="status disconnected" id="connectionStatus">연결 상태: 대기 중</div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let peerConnection = null;
        let localStream = null;
        let dataChannel = null;
        let isConnected = false;
        let keepAliveInterval = null;
        let connectionCode = '';
        
        // DOM 요소
        const startBtn = document.getElementById('startBtn');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const connectionCodeDisplay = document.getElementById('connectionCode');
        const viewerCodeInput = document.getElementById('viewerCodeInput');
        const connectBtn = document.getElementById('connectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const httpWarning = document.getElementById('httpWarning');
        
        // HTTP 경고 표시
        if (window.location.protocol === 'http:' && 
            window.location.hostname !== 'localhost' && 
            window.location.hostname !== '127.0.0.1') {
            httpWarning.classList.remove('hidden');
        }
        
        // WebRTC 설정
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ]
        };
        
        // 6자리 랜덤 코드 생성
        function generateRandomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        // 화면 캡처 시작
        async function startCapture() {
            try {
                // 화면 공유 API 지원 확인
                if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                    alert('이 브라우저는 화면 공유를 지원하지 않습니다. Chrome, Firefox, Edge 최신 버전을 사용해주세요.');
                    return false;
                }
                
                // 화면 공유 요청
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: 'always' },
                    audio: false
                });
                
                // 사용자가 화면 공유를 중단했을 때 처리
                localStream.getVideoTracks()[0].addEventListener('ended', () => {
                    if (isConnected) {
                        setTimeout(async () => {
                            if (isConnected) {
                                if (confirm('화면 공유가 중단되었습니다. 다시 시작하시겠습니까?')) {
                                    await restartCapture();
                                }
                            }
                        }, 500);
                    }
                });
                
                return true;
            } catch (err) {
                console.error('화면 캡처 오류:', err);
                return false;
            }
        }
        
        // 화면 캡처 재시작
        async function restartCapture() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            const result = await startCapture();
            
            if (result && peerConnection) {
                // 기존 트랙 제거
                const senders = peerConnection.getSenders();
                senders.forEach(sender => {
                    if (sender.track && sender.track.kind === 'video') {
                        peerConnection.removeTrack(sender);
                    }
                });
                
                // 새 트랙 추가
                localStream.getVideoTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            return result;
        }
        
        // 시그널링 서버 역할을 하는 전역 객체 (실제 서버가 없이 동작하도록)
        const signalServer = {
            connections: {},
            
            // 연결 코드 등록
            register(code, callbacks) {
                this.connections[code] = callbacks;
            },
            
            // 연결 코드 제거
            unregister(code) {
                delete this.connections[code];
            },
            
            // 수신 측에 신호 전달
            sendToReceiver(senderCode, data) {
                const receiver = this.connections[data.receiverCode];
                if (receiver && receiver.onMessage) {
                    setTimeout(() => {
                        receiver.onMessage({
                            senderCode,
                            ...data
                        });
                    }, 10);
                }
            }
        };
        
        // P2P 연결 설정
        async function setupPeerConnection() {
            if (peerConnection) {
                peerConnection.close();
            }
            
            peerConnection = new RTCPeerConnection(configuration);
            
            // 데이터 채널 생성
            dataChannel = peerConnection.createDataChannel('controlChannel', {
                ordered: true
            });
            
            setupDataChannel(dataChannel);
            
            // 트랙 추가
            if (localStream) {
                localStream.getVideoTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // ICE 후보 처리
            peerConnection.onicecandidate = event => {
                if (event.candidate && signalServer.connections[connectionCode]) {
                    signalServer.sendToReceiver(connectionCode, {
                        type: 'ice-candidate',
                        receiverCode: viewerCodeInput.value,
                        candidate: event.candidate
                    });
                }
            };
            
            // 연결 상태 변화 감지
            peerConnection.onconnectionstatechange = () => {
                updateConnectionStatus(peerConnection.connectionState);
                
                if (peerConnection.connectionState === 'connected') {
                    isConnected = true;
                    startKeepAlive();
                } else if (peerConnection.connectionState === 'disconnected' || 
                          peerConnection.connectionState === 'failed' ||
                          peerConnection.connectionState === 'closed') {
                    isConnected = false;
                    stopKeepAlive();
                }
            };
            
            return peerConnection;
        }
        
        // 데이터 채널 설정
        function setupDataChannel(channel) {
            channel.onopen = () => {
                console.log('데이터 채널 열림');
                sendStatusUpdate();
            };
            
            channel.onclose = () => {
                console.log('데이터 채널 닫힘');
            };
            
            channel.onerror = (error) => {
                console.error('데이터 채널 오류:', error);
            };
            
            channel.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleControlMessage(message);
                } catch (err) {
                    console.error('메시지 처리 오류:', err);
                }
            };
        }
        
        // 제어 메시지 처리
        function handleControlMessage(message) {
            switch (message.type) {
                case 'ping':
                    sendControlMessage({ type: 'pong', timestamp: Date.now() });
                    break;
                    
                case 'restart':
                    restartCapture();
                    break;
                    
                case 'quality':
                    adjustStreamQuality(message.value);
                    break;
            }
        }
        
        // 제어 메시지 전송
        function sendControlMessage(message) {
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify(message));
            }
        }
        
        // 상태 업데이트 전송
        function sendStatusUpdate() {
            if (dataChannel && dataChannel.readyState === 'open') {
                const statusMessage = {
                    type: 'status',
                    timestamp: Date.now(),
                    screenActive: localStream && localStream.getVideoTracks()[0].readyState === 'live'
                };
                
                sendControlMessage(statusMessage);
            }
        }
        
        // 연결 상태 업데이트
        function updateConnectionStatus(state) {
            switch (state) {
                case 'new':
                case 'checking':
                case 'connecting':
                    connectionStatus.textContent = '연결 상태: 연결 중...';
                    connectionStatus.className = 'status connecting';
                    break;
                    
                case 'connected':
                    connectionStatus.textContent = '연결 상태: 연결됨';
                    connectionStatus.className = 'status connected';
                    break;
                    
                case 'disconnected':
                    connectionStatus.textContent = '연결 상태: 연결 끊김';
                    connectionStatus.className = 'status disconnected';
                    break;
                    
                case 'failed':
                    connectionStatus.textContent = '연결 상태: 연결 실패';
                    connectionStatus.className = 'status disconnected';
                    break;
                    
                case 'closed':
                    connectionStatus.textContent = '연결 상태: 연결 종료됨';
                    connectionStatus.className = 'status disconnected';
                    break;
            }
        }
        
        // 스트림 품질 조정
        function adjustStreamQuality(quality) {
            if (!localStream) return;
            
            const videoTrack = localStream.getVideoTracks()[0];
            if (!videoTrack) return;
            
            try {
                const constraints = {};
                
                switch (quality) {
                    case 'high':
                        constraints.width = { ideal: 1920 };
                        constraints.height = { ideal: 1080 };
                        break;
                        
                    case 'medium':
                        constraints.width = { ideal: 1280 };
                        constraints.height = { ideal: 720 };
                        break;
                        
                    case 'low':
                        constraints.width = { ideal: 854 };
                        constraints.height = { ideal: 480 };
                        break;
                        
                    case 'minimal':
                        constraints.width = { ideal: 640 };
                        constraints.height = { ideal: 360 };
                        break;
                }
                
                if (Object.keys(constraints).length > 0) {
                    videoTrack.applyConstraints(constraints);
                }
            } catch (err) {
                console.error('스트림 품질 조정 오류:', err);
            }
        }
        
        // 연결 유지 기능
        function startKeepAlive() {
            stopKeepAlive();
            keepAliveInterval = setInterval(() => {
                sendStatusUpdate();
            }, 10000);
        }
        
        function stopKeepAlive() {
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
        }
        
        // 메시지 수신 처리
        function handleSignalingMessage(message) {
            if (!peerConnection) return;
            
            switch (message.type) {
                case 'offer':
                    handleOfferMessage(message);
                    break;
                    
                case 'answer':
                    handleAnswerMessage(message);
                    break;
                    
                case 'ice-candidate':
                    handleIceCandidateMessage(message);
                    break;
            }
        }
        
        // SDP 제안 처리
        async function handleOfferMessage(message) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                signalServer.sendToReceiver(connectionCode, {
                    type: 'answer',
                    receiverCode: message.senderCode,
                    sdp: peerConnection.localDescription
                });
            } catch (err) {
                console.error('제안 처리 오류:', err);
            }
        }
        
        // SDP 응답 처리
        async function handleAnswerMessage(message) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
            } catch (err) {
                console.error('응답 처리 오류:', err);
            }
        }
        
        // ICE 후보 처리
        async function handleIceCandidateMessage(message) {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
            } catch (err) {
                console.error('ICE 후보 처리 오류:', err);
            }
        }
        
        // 연결 시작
        async function startConnection() {
            if (!viewerCodeInput.value) {
                alert('뷰어 코드를 입력해주세요.');
                return;
            }
            
            if (viewerCodeInput.value.length !== 4) {
                alert('뷰어 코드는 4자리여야 합니다.');
                return;
            }
            
            try {
                updateConnectionStatus('connecting');
                
                await setupPeerConnection();
                
                const offer = await peerConnection.createOffer({
                    offerToReceiveVideo: false,
                    offerToReceiveAudio: false
                });
                
                await peerConnection.setLocalDescription(offer);
                
                signalServer.sendToReceiver(connectionCode, {
                    type: 'offer',
                    receiverCode: viewerCodeInput.value,
                    sdp: peerConnection.localDescription
                });
            } catch (err) {
                console.error('연결 시작 오류:', err);
                alert('연결에 실패했습니다: ' + err.message);
                updateConnectionStatus('disconnected');
            }
        }
        
        // 화면 공유 시작 버튼 이벤트
        startBtn.addEventListener('click', async () => {
            const captureStarted = await startCapture();
            
            if (captureStarted) {
                // 연결 코드 생성
                connectionCode = generateRandomCode();
                connectionCodeDisplay.textContent = connectionCode;
                
                // 시그널링 서버에 등록
                signalServer.register(connectionCode, {
                    onMessage: handleSignalingMessage
                });
                
                // UI 업데이트
                step1.style.display = 'none';
                step2.style.display = 'block';
            } else {
                alert('화면 공유를 시작할 수 없습니다. 브라우저 권한을 확인해주세요.');
            }
        });
        
        // 연결 버튼 이벤트
        connectBtn.addEventListener('click', startConnection);
        
        // 코드 복사 버튼 이벤트
        copyCodeBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(connectionCode)
                .then(() => {
                    alert('코드가 클립보드에 복사되었습니다.');
                })
                .catch(err => {
                    console.error('복사 실패:', err);
                    
                    // 대체 복사 방법
                    const tempInput = document.createElement('textarea');
                    tempInput.value = connectionCode;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    
                    try {
                        document.execCommand('copy');
                        alert('코드가 클립보드에 복사되었습니다.');
                    } catch (err) {
                        alert('복사 실패. 코드를 직접 선택하여 복사해주세요: ' + connectionCode);
                    }
                    
                    document.body.removeChild(tempInput);
                });
        });
        
        // 페이지 종료 경고
        window.addEventListener('beforeunload', (event) => {
            if (isConnected) {
                const message = '화면 공유 중입니다. 정말 나가시겠습니까?';
                event.returnValue = message;
                return message;
            }
        });
    </script>
</body>
</html>
